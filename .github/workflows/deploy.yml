name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Image Tag 결정 ----------
      - name: Set Image Tag
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          fi

      # ---------- GHCR Login ----------
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ---------- Build & Push ----------
      - name: Build & Push Docker Image
        run: |
          docker build -t ghcr.io/${{ secrets.GHCR_USER }}/book-preprocessing-worker:${IMAGE_TAG} .
          docker push ghcr.io/${{ secrets.GHCR_USER }}/book-preprocessing-worker:${IMAGE_TAG}

      # ---------- AWS Credentials ----------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # ---------- SG Open ----------
      - name: Allow SSH from GitHub Actions
        run: |
          IP=$(curl -s https://checkip.amazonaws.com)
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr $IP/32

      # ---------- Deploy ----------
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        envs: GHCR_USER,GHCR_TOKEN,KAFKA_BOOTSTRAP_SERVERS,KAFKA_USERNAME,KAFKA_PASSWORD,IMAGE_TAG
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -e

            echo "Login GHCR"
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            echo "Pull Image"
            docker pull ghcr.io/$GHCR_USER/book-preprocessing-worker:$IMAGE_TAG

            echo "Stop old container"
            docker stop book-preprocessing-worker || true
            docker rm book-preprocessing-worker || true

            echo "Run new container"
            docker run -d \
              --name book-preprocessing-worker \
              -p 9002:9002 \
              -e SPRING_PROFILES_ACTIVE=${{ job.environment }} \
              -e KAFKA_BOOTSTRAP_SERVERS="$KAFKA_BOOTSTRAP_SERVERS" \
              -e KAFKA_USERNAME="$KAFKA_USERNAME" \
              -e KAFKA_PASSWORD="$KAFKA_PASSWORD" \
              --restart unless-stopped \
              --memory="512m" \
              --cpus="0.5" \
              ghcr.io/$GHCR_USER/book-preprocessing-worker:$IMAGE_TAG

            echo "Health check wait..."
            for i in {1..10}; do
              if curl -sf http://localhost:9002/actuator/health; then
                echo "Service is healthy"
                exit 0
              fi
              sleep 5
            done

            echo "Health check failed"
            docker logs book-preprocessing-worker
            exit 1

      # ---------- SG Close ----------
      - name: Remove SSH Rule
        if: always()
        run: |
          IP=$(curl -s https://checkip.amazonaws.com)
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr $IP/32
