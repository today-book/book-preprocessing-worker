name: CD - Deploy Dev (EC2 + SSH + Dynamic SG)

on:
  workflow_run:
    workflows: ["CI - Build & Publish Image"]
    types: [completed]

jobs:
  deploy-dev:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    runs-on: ubuntu-latest
    environment: deploy

    steps:
      # 1) Runner IP ÌôïÎ≥¥
      - name: Capture Runner IP
        run: |
          IP=$(curl -s https://checkip.amazonaws.com)
          echo "RUNNER_IP=$IP" >> $GITHUB_ENV

      # 2) AWS ÏûêÍ≤© Ï¶ùÎ™Ö
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      # 3) SGÏóê Runner IP ÌóàÏö©
      - name: Allow Runner IP in Security Group (SSH)
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id "${{ secrets.AWS_SG_ID }}" \
            --protocol tcp \
            --port 22 \
            --cidr "$RUNNER_IP/32" || true

      # 4) EC2 Î∞∞Ìè¨
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key:      ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -euo pipefail

            GHCR_USER='${{ secrets.GHCR_USER }}'
            GHCR_TOKEN='${{ secrets.GHCR_TOKEN }}'

            SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
            DATE=$(date +'%Y%m%d')
            IMAGE_TAG="dev-${DATE}-${SHORT_SHA}"
            IMAGE="ghcr.io/${GHCR_USER}/book-preprocessing-worker:${IMAGE_TAG}"

            echo "Deploy image: ${IMAGE}"

            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_USER}" --password-stdin
            docker pull "${IMAGE}"

            docker stop book-preprocessing-worker || true
            docker rm book-preprocessing-worker || true

            docker run -d \
              --name book-preprocessing-worker \
              -p 9002:9002 \
              -e SPRING_PROFILES_ACTIVE=dev \
              -e KAFKA_BOOTSTRAP_SERVERS="${{ secrets.DEV_KAFKA_BOOTSTRAP_SERVERS }}" \
              -e KAFKA_USERNAME="${{ secrets.DEV_KAFKA_USERNAME }}" \
              -e KAFKA_PASSWORD="${{ secrets.DEV_KAFKA_PASSWORD }}" \
              --memory="512m" \
              --cpus="0.5" \
              --restart unless-stopped \
              "${IMAGE}"

            echo "Healthcheck..."
            for i in {1..12}; do
              if curl -sf http://localhost:9002/actuator/health > /dev/null; then
                echo "‚úÖ Service is healthy"
                exit 0
              fi
              sleep 5
            done

            echo "‚ùå Health check failed"
            docker logs book-preprocessing-worker | tail -200
            exit 1

      # 5) Ïã§Ìå® ÏïåÎ¶º
      - name: Notify Slack on Deployment Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "üö® DEV Î∞∞Ìè¨ Ïã§Ìå®",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Service:* book-preprocessing-worker\n*Image:* dev-${{ github.event.workflow_run.head_sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # 6) SG Ï†ïÎ¶¨
      - name: Revoke Runner IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id "${{ secrets.AWS_SG_ID }}" \
            --protocol tcp \
            --port 22 \
            --cidr "$RUNNER_IP/32" || true
