name: CD - Deploy Dev (EC2 + SSH + Dynamic SG)

on:
  workflow_run:
    workflows: ["CI - Build & Publish Image"]
    types: [completed]

jobs:
  deploy-dev:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    runs-on: ubuntu-latest
    environment: deploy

    steps:
      # 1) Runner IP í™•ë³´ (SG allow/denyì— ë™ì¼ ê°’ ì‚¬ìš©)
      - name: Capture Runner IP
        run: |
          IP=$(curl -s https://checkip.amazonaws.com)
          echo "RUNNER_IP=$IP" >> $GITHUB_ENV
          echo "Runner IP: $IP"

      # 2) AWS ìê²© ì¦ëª… ì„¤ì • (devìš©)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      # 3) SGì— Runner IP ì„ì‹œ í—ˆìš©(SSH)
      - name: Allow Runner IP in Security Group (SSH 22)
        run: |
          echo "Authorize SSH from $RUNNER_IP/32 to SG=${{ secrets.AWS_SG_ID }}"
          aws ec2 authorize-security-group-ingress \
            --group-id "${{ secrets.AWS_SG_ID }}" \
            --protocol tcp \
            --port 22 \
            --cidr "$RUNNER_IP/32" || true

      # 4) EC2ì— SSHë¡œ ë°°í¬ (CIê°€ ë§Œë“  íƒœê·¸ ì‚¬ìš©)
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -euo pipefail

            GHCR_USER='${{ secrets.GHCR_USER }}'
            GHCR_TOKEN='${{ secrets.GHCR_TOKEN }}'

            IMAGE_TAG='${{ github.event.workflow_run.outputs.image_tag }}'
            IMAGE="ghcr.io/${GHCR_USER}/book-preprocessing-worker:${IMAGE_TAG}"

            KAFKA_BOOTSTRAP_SERVERS='${{ secrets.DEV_KAFKA_BOOTSTRAP_SERVERS }}'
            KAFKA_USERNAME='${{ secrets.DEV_KAFKA_USERNAME }}'
            KAFKA_PASSWORD='${{ secrets.DEV_KAFKA_PASSWORD }}'

            echo "Login GHCR & Pull image: ${IMAGE}"
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_USER}" --password-stdin
            docker pull "${IMAGE}"

            echo "Stop/Rm old container..."
            docker stop book-preprocessing-worker || true
            docker rm book-preprocessing-worker || true

            echo "Run new container..."
            docker run -d \
              --name book-preprocessing-worker \
              -p 9002:9002 \
              -e SPRING_PROFILES_ACTIVE=dev \
              -e KAFKA_BOOTSTRAP_SERVERS="${KAFKA_BOOTSTRAP_SERVERS}" \
              -e KAFKA_USERNAME="${KAFKA_USERNAME}" \
              -e KAFKA_PASSWORD="${KAFKA_PASSWORD}" \
              --memory="512m" \
              --cpus="0.5" \
              --restart unless-stopped \
              "${IMAGE}"

            docker image prune -f

            echo "Healthcheck..."
            for i in {1..12}; do
              if curl -sf http://localhost:9002/actuator/health > /dev/null; then
                echo "âœ… Service is healthy"
                exit 0
              fi
              echo "Waiting... ($i/12)"
              sleep 5
            done

            echo "âŒ Health check failed"
            docker logs book-preprocessing-worker | tail -200
            exit 1

      # 5) ì‹¤íŒ¨ ì „ìš© Slack ì•Œë¦¼ (ì„±ê³µ ì•Œë¦¼ ì—†ìŒ)
      - name: Notify Slack on Deployment Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "ğŸš¨ DEV ë°°í¬ ì‹¤íŒ¨",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "ğŸš¨ DEV ë°°í¬ ì‹¤íŒ¨", "emoji": true }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Service*\nbook-preprocessing-worker" },
                    { "type": "mrkdwn", "text": "*Branch*\n`${{ github.event.workflow_run.head_branch }}`" },
                    { "type": "mrkdwn", "text": "*Commit*\n`${{ github.event.workflow_run.head_sha }}`" },
                    { "type": "mrkdwn", "text": "*Image Tag*\n`${{ github.event.workflow_run.outputs.image_tag }}`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "ğŸ” *Workflow Run*\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # 6) SG ê·œì¹™ ì •ë¦¬ (í•­ìƒ ìˆ˜í–‰)
      - name: Revoke Runner IP from Security Group
        if: always()
        run: |
          echo "Revoke SSH from $RUNNER_IP/32 to SG=${{ secrets.AWS_SG_ID }}"
          aws ec2 revoke-security-group-ingress \
            --group-id "${{ secrets.AWS_SG_ID }}" \
            --protocol tcp \
            --port 22 \
            --cidr "$RUNNER_IP/32" || true
