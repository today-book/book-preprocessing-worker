name: CD - Deploy Prod

on:
  workflow_run:
    workflows: ["CI - Build & Publish Image"]
    types: [completed]

jobs:
  deploy-prod:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Set variables from CI output
        run: |
          echo "IMAGE_TAG=${{ github.event.workflow_run.outputs.image_tag }}" >> $GITHUB_ENV
          echo "IMAGE_URI=${{ secrets.ECR_REPOSITORY }}:${{ github.event.workflow_run.outputs.image_tag }}" >> $GITHUB_ENV

      - name: Render ECS Task Definition (from template)
        id: taskdef
        run: |
          set -euo pipefail

          cp infra/ecs/taskdef.json.tmpl /tmp/taskdef.json

          sed -i "s|__IMAGE__|${IMAGE_URI}|g" /tmp/taskdef.json
          sed -i "s|__EXECUTION_ROLE_ARN__|${{ secrets.ECS_EXECUTION_ROLE_ARN }}|g" /tmp/taskdef.json
          sed -i "s|__TASK_ROLE_ARN__|${{ secrets.ECS_TASK_ROLE_ARN }}|g" /tmp/taskdef.json
          sed -i "s|__LOG_GROUP__|${{ secrets.ECS_LOG_GROUP }}|g" /tmp/taskdef.json
          sed -i "s|__AWS_REGION__|ap-northeast-2|g" /tmp/taskdef.json

          TASKDEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file:///tmp/taskdef.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          echo "TASKDEF_ARN=${TASKDEF_ARN}" >> $GITHUB_OUTPUT
          echo "Registered TaskDefinition: ${TASKDEF_ARN}"

      - name: Render AppSpec (inject TaskDefinition ARN)
        id: appspec
        run: |
          set -euo pipefail

          cp infra/ecs/appspec.yaml.tmpl /tmp/appspec.yaml
          sed -i "s|<TASK_DEFINITION>|${{ steps.taskdef.outputs.TASKDEF_ARN }}|g" /tmp/appspec.yaml

          echo "APPSPEC_FILE=/tmp/appspec.yaml" >> $GITHUB_OUTPUT

      - name: Create CodeDeploy Deployment (ECS Blue/Green)
        id: codedeploy
        run: |
          set -euo pipefail

          APPSPEC_CONTENT=$(base64 -w 0 "${{ steps.appspec.outputs.APPSPEC_FILE }}")

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "${{ secrets.CODEDEPLOY_APP }}" \
            --deployment-group-name "${{ secrets.CODEDEPLOY_DG }}" \
            --revision "revisionType=AppSpecContent,appSpecContent={content=${APPSPEC_CONTENT}}" \
            --query "deploymentId" \
            --output text)

          echo "DEPLOYMENT_ID=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
          echo "CodeDeploy DeploymentId: ${DEPLOYMENT_ID}"

      - name: Wait for deployment result
        run: |
          aws deploy wait deployment-successful \
            --deployment-id "${{ steps.codedeploy.outputs.DEPLOYMENT_ID }}"