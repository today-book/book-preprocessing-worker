name: CD (dev) - Deploy to Dev

on:
  workflow_run:
    workflows: ["CI (dev) - Build & Push Image"]
    types: [completed]

permissions:
  contents: read
  packages: read

concurrency:
  group: dev-deploy
  cancel-in-progress: true

env:
  APP_NAME: book-preprocessing-worker
  APP_PORT: 9002

jobs:
  deploy:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'dev'
      }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to dev server
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: dev-${{ github.event.workflow_run.head_sha }}
          APP_NAME: ${{ env.APP_NAME }}
          APP_PORT: ${{ env.APP_PORT }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.DEV_REMOTE_IP }}
          username: ubuntu
          key: ${{ secrets.DEV_REMOTE_PRIVATE_KEY }}
          port: ${{ secrets.DEV_REMOTE_SSH_PORT }}
          envs: IMAGE_TAG,APP_NAME,APP_PORT,GHCR_TOKEN,GHCR_USER
          script: |
            set -e
            cd /home/ubuntu/app/${APP_NAME}
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
            ./deploy.sh